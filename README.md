# H-CUBE 인증 서버

이 서버는 OAuath를 통한 인증을 수행하고 JWT를 반환할 것이다.

## Desired User Flow

이 서버는 다음과 같이 작동하도록 구현하고자 한다. 아래에서 `서버`라 함은 인증 서버를 말한다.

1. 임의의 도메인의 임의의 페이지에서 유저가 로그인 버튼을 누른다. 이때 로그인이 완료된 후 리다이렉션할 페이지와 실패했을 때 리다이렉션할 페이지를 파라매터로 받는다.
2. 서버는 로그인 후 그 성공 여부에 따라 유저를 리다이렉션한다. 이때 서버는 임시 키와 JWT를 생성하여 `임시 키:JWT` 튜플을 저정한 후 쿠키로 임시 키를 함께 전송한다.
3. 유저는 쿠키로부터 임시 키를 얻는다.
4. 이후 유저는 임시 키를 사용하여 서버에 JWT를 요청한다.
5. 서버는 요청된 키에 해당하는 JWT를 가져온 후, 저장된 튜플을 제거한다.
6. 서버는 유저에게 JWT를 반환한다.
7. 유저는 받은 JWT를 이용하여 백엔드 서비스를 요청하고 백엔드 서비스에서는 유저를 검증한 후 서비스를 제공한다.

## Challanges

이 서버는 완전히 독립적으로 사용될 수 있게 설계하고자 한다. 이때 다음과 같은 문제들이 발생한다.

1. 공격자가 우리 서비스를 사칭하는 것을 어떻게 방어할 것인가? 예를 들어 `h-cube.com` 도메인을 가진 공격자가 우리 서비스를 사칭하여 유저가 로그인하록 유도한 뒤 JWT를 얻어내어 마음대로 api 호출을 할 수도 있다.

2. 이 방법이 세션보다 우수한가? 세션 정보를 DB에 저장해놓고 가져다쓰는 편이 훨씬 간편하지 않은가? 세션이 CSRF 공격에 취약하다지만, 그렇다면 세션 정보를 쿠키 대신 localStorage에 저장해둔 후 이를 명시적으로 요청 헤더에 포함한 fetch요청을 하면 되지 않는가?

3. 익명 유저는 어떻게 구현할 것인가?

4. XSS공격을 당해서 JWT가 탈취될 수 있다. 이 경우 서버단에서 이를 차단할 방법이 있는가?

## Solutions

1. JWT를 얻으려면 거기에 앞서 임시 키를 얻어야 하는데, 이 임시 키는 리다이렉션에서 쿠키로 주어진다. 이때 리다이렉션 URL을 검사하여 도메인이 우리가 소유한 도메인이 맞는지 확인하면 된다. 그렇게 하면 원천적으로 우리가 소유한 도메인이 아닌 다른 다른 도메인으로 JWT정보가 넘어가는 것을 막을 수 있다.

2. 보안상으로는 세션보다 우수하지 않다. 그러나 JWT방식의 가장 큰 장점은 scalable하다는 점이다. 세션 방식을 사용할 때 세션 정보가 메모리상에 존재한다면 백엔드 서버를 확장했을 때 같은 유저의 요청은 반드시 같은 서버에 할당되어야 한다. 만약 세션 정보가 DB에 저장된다면 매 API 요청마다 DB 질의가 필요하다. 대부분의 API에서 DB 질의는 한두 번 정도만 발생할 것이다. 따라서 매 요청마다 DB 질의 하나를 줄이면 25~30%정도의 DB 요청을 줄이는 것이다.

3. 익명 유저의 경우 별다른 검증을 하지 않는 유저 추가 API를 하나 더 생성하여 처리하도록 하자.

4. XSS 공격을 당했을 경우 어떤 서비스도 안전하지 않다. 현재 쿠키와 로컬 스토리지 정보 등을 전부 공격자에게 전달할 수 있기 때문이다. 이 경우 공격자는 피해자를 완벽하게 모사할 수 있으므로 서버에서는 절대로 공격자와 피해자를 구분할 수 없다. XSS는 백엔드단에서 완벽하게 차단해야만 한다.

## Compare with Session

만약 세션 방식을 사용한다면 인증 서버는 다음과 같이 작동할 것이다.

1. OAuth를 통해 유저 로그인을 확인한다. 이때 로그인 성공 및 실패 관련 처리를 모두 수행한다.
2. 세션 키를 발행하여 `(세션 키, 유저 ID)` 정보를 데이터베이스에 저장한다.
3. 원래 서비스로 리다이렉션하면서 쿠키를 통하여 세션 키를 전달한다.
4. 이후로는 세션 키를 로컬스토리지에 저장한 후 데이터베이스와 비교하며 인증에 이용한다.

이 방법이 비교적 구현이 간단하기는 하나 상기한 여러 문제들이 있어 JWT에 비해 월등히 우월하다고는 보기 힘들다. 우리는 실제로 프로덕트를 만드는 게 아니라 그 연습을 하는 것인 만큼 JWT를 공부하는 셈 치고 써 보기로 하자.

## `secrets.js`

```
module.exports = {
    clientID: 'abc.....asdf',
    callbackURL: 'https://auth.the-form.io/oauth/kakao/callback',
    rootDomain: 'the-form.io'
}
```
